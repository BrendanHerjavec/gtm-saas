generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Auth.js Models
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Multi-tenant Organization
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users          User[]
  recipients     Recipient[]
  sends          Send[]
  giftItems      GiftItem[]
  giftCategories GiftCategory[]
  campaigns      Campaign[]
  budgets        Budget[]
  activities     Activity[]
  crmIntegration CRMIntegration?
  vendors        Vendor[]
  outreachTasks  OutreachTask[]
  taskDecks      TaskDeck[]
  companies      Company[]
  contacts       Contact[]
  leads          Lead[]
  dealStages     DealStage[]
  deals          Deal[]
}

// CRM Integration - One per Organization (for syncing recipients)
model CRMIntegration {
  id               String    @id @default(uuid())
  organizationId   String    @unique
  provider         String    // "hubspot" | "salesforce" | "attio"
  accessToken      String    @db.Text
  refreshToken     String?   @db.Text
  tokenExpiresAt   DateTime?
  instanceUrl      String?
  status           String    @default("CONNECTED")
  lastSyncAt       DateTime?
  lastSyncStatus   String?
  lastSyncError    String?   @db.Text
  webhookSecret    String?
  webhookId        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  syncLogs     SyncLog[]
}

model SyncLog {
  id               String    @id @default(uuid())
  integrationId    String
  entityType       String
  operation        String
  direction        String
  status           String
  recordsProcessed Int       @default(0)
  recordsCreated   Int       @default(0)
  recordsUpdated   Int       @default(0)
  recordsSkipped   Int       @default(0)
  recordsFailed    Int       @default(0)
  errorMessage     String?   @db.Text
  metadata         String?   @db.Text
  startedAt        DateTime  @default(now())
  completedAt      DateTime?

  integration CRMIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
}

// User with organization membership
model User {
  id             String    @id @default(uuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?
  password       String?
  role           String    @default("MEMBER")
  organizationId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts       Account[]
  sessions       Session[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
  sends          Send[]
  activities     Activity[]
  campaigns      Campaign[]
  assignedTasks  OutreachTask[] @relation("AssignedTasks")
  completedTasks OutreachTask[] @relation("CompletedTasks")
  createdDecks   TaskDeck[]
}

// =====================
// HIGH-TOUCH MARKETPLACE MODELS
// =====================

// Gestures - Marketplace items available for campaigns (global catalog)
model Gesture {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  category    String  // sustainability | food | gifting | wellness | experiences | personal
  icon        String  // Lucide icon name (e.g., "TreePine", "Coffee")
  minPrice    Float
  maxPrice    Float
  currency    String  @default("USD")
  popular     Boolean @default(false)
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaignSteps CampaignStep[]

  @@index([category])
  @@index([isActive])
}

// Recipients - People who receive gifts/touches (synced from CRM)
model Recipient {
  id             String   @id @default(uuid())
  email          String
  firstName      String?
  lastName       String?
  phone          String?
  company        String?
  jobTitle       String?
  linkedinUrl    String?
  address        String?  @db.Text // JSON: { street, city, state, zip, country }
  notes          String?  @db.Text
  tags           String?  // Comma-separated tags
  customFields   String?  @db.Text
  organizationId String

  // External CRM sync tracking
  externalId     String?
  externalSource String?   // "hubspot" | "salesforce" | "attio"
  externalUrl    String?
  lastSyncedAt   DateTime?
  syncStatus     String?   @default("SYNCED")

  // Gifting preferences
  preferences    String?  @db.Text // JSON: dietary restrictions, interests, etc.
  doNotSend      Boolean  @default(false)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sends          Send[]
  activities     Activity[]
  campaigns      CampaignRecipient[]
  outreachTasks  OutreachTask[]

  @@index([organizationId, externalId, externalSource])
  @@index([organizationId, email])
}

// Gift Categories
model GiftCategory {
  id             String   @id @default(uuid())
  name           String
  description    String?
  icon           String?  // Lucide icon name
  color          String?  // Hex color for UI
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  giftItems    GiftItem[]
}

// Gift Items in Catalog
model GiftItem {
  id             String   @id @default(uuid())
  name           String
  description    String?  @db.Text
  imageUrl       String?
  price          Float
  currency       String   @default("USD")
  categoryId     String?
  vendorId       String?
  sku            String?
  inStock        Boolean  @default(true)
  isActive       Boolean  @default(true)

  // Item type
  type           String   @default("PHYSICAL") // PHYSICAL | DIGITAL | EXPERIENCE

  // For experiences
  duration       String?  // e.g., "2 hours", "1 day"
  location       String?

  // Metadata
  tags           String?  // Comma-separated
  customFields   String?  @db.Text
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     GiftCategory? @relation(fields: [categoryId], references: [id])
  vendor       Vendor?       @relation(fields: [vendorId], references: [id])
  sends        Send[]
}

// Vendors / Fulfillment Partners
model Vendor {
  id             String   @id @default(uuid())
  name           String
  type           String   // "sendoso" | "postal" | "reachdesk" | "alyce" | "custom"
  apiKey         String?  @db.Text
  apiSecret      String?  @db.Text
  webhookUrl     String?
  isActive       Boolean  @default(true)
  settings       String?  @db.Text // JSON config
  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  giftItems    GiftItem[]
  sends        Send[]
}

// Sends - The core action (sending gifts/touches)
model Send {
  id             String    @id @default(uuid())
  recipientId    String
  giftItemId     String?
  campaignId     String?
  userId         String    // Who initiated the send
  vendorId       String?

  // Send details
  type           String    @default("GIFT") // GIFT | HANDWRITTEN_NOTE | VIDEO | EXPERIENCE | DIRECT_MAIL
  status         String    @default("PENDING") // PENDING | PROCESSING | SHIPPED | DELIVERED | FAILED | CANCELLED

  // Personalization
  message        String?   @db.Text
  videoUrl       String?

  // Shipping info
  shippingAddress String?  @db.Text // JSON
  trackingNumber  String?
  trackingUrl     String?
  carrier         String?

  // Cost tracking
  itemCost       Float     @default(0)
  shippingCost   Float     @default(0)
  totalCost      Float     @default(0)
  currency       String    @default("USD")

  // Timing
  scheduledAt    DateTime?
  sentAt         DateTime?
  deliveredAt    DateTime?

  // Trigger info (what caused this send)
  triggerType    String?   // "manual" | "campaign" | "automation" | "trigger_rule"
  triggerData    String?   @db.Text // JSON with context

  // External references
  externalOrderId String?
  vendorOrderId   String?

  notes          String?   @db.Text
  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization  Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  recipient     Recipient     @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  giftItem      GiftItem?     @relation(fields: [giftItemId], references: [id])
  campaign      Campaign?     @relation(fields: [campaignId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  vendor        Vendor?       @relation(fields: [vendorId], references: [id])
  activities    Activity[]
  outreachTask  OutreachTask?

  @@index([organizationId, status])
  @@index([recipientId])
  @@index([campaignId])
}

// Campaigns - Grouped sends for tracking
model Campaign {
  id             String    @id @default(uuid())
  name           String
  description    String?   @db.Text
  status         String    @default("DRAFT") // DRAFT | ACTIVE | PAUSED | COMPLETED
  type           String    @default("MANUAL") // MANUAL | TRIGGERED | SCHEDULED

  // Budget
  budgetAmount   Float?
  budgetSpent    Float     @default(0)

  // Trigger rules (for automated campaigns)
  triggerRules   String?   @db.Text // JSON: conditions for auto-sending

  // Schedule
  startDate      DateTime?
  endDate        DateTime?

  organizationId String
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User         @relation(fields: [createdById], references: [id])
  sends          Send[]
  stats          CampaignStats?
  steps          CampaignStep[]
  recipients     CampaignRecipient[]
  outreachTasks  OutreachTask[]
}

// Campaign Recipients - Many-to-many relation
model CampaignRecipient {
  id          String   @id @default(uuid())
  campaignId  String
  recipientId String
  status      String   @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED | FAILED
  currentStep Int      @default(0) // Which step they're on (0 = not started)
  addedAt     DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  campaign  Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  recipient Recipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([campaignId, recipientId])
  @@index([campaignId])
  @@index([recipientId])
}

// Campaign Steps - Multi-step campaign flows
model CampaignStep {
  id          String  @id @default(uuid())
  campaignId  String
  stepOrder   Int     // Order in the sequence (1, 2, 3...)
  stepType    String  // EMAIL | GESTURE | DELAY

  // For EMAIL steps
  emailSubject  String?
  emailContent  String? @db.Text

  // For GESTURE steps
  gestureId     String?
  gestureNote   String? @db.Text // Personalized message to include

  // For DELAY steps
  delayDays     Int?
  delayHours    Int?

  // Step-level settings
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  gesture  Gesture?  @relation(fields: [gestureId], references: [id])

  @@index([campaignId, stepOrder])
}

model CampaignStats {
  id            String   @id @default(uuid())
  campaignId    String   @unique
  totalSends    Int      @default(0)
  pending       Int      @default(0)
  processing    Int      @default(0)
  shipped       Int      @default(0)
  delivered     Int      @default(0)
  failed        Int      @default(0)
  totalSpent    Float    @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
}

// Task Deck - A collection of tasks that can be "opened" like a card pack
model TaskDeck {
  id             String    @id @default(uuid())

  // Basic info
  name           String
  description    String?   @db.Text

  // Visual customization
  coverColor     String?   // Hex color (e.g., "#3B82F6")
  emoji          String?   // Optional emoji icon

  // Status tracking
  status         String    @default("SEALED") // SEALED | OPENING | OPENED | COMPLETED
  openedAt       DateTime?
  completedAt    DateTime?

  // Stats (denormalized for performance)
  totalTasks     Int       @default(0)
  completedTasks Int       @default(0)
  skippedTasks   Int       @default(0)

  // Source - how was this deck created?
  sourceType     String?   // "campaign" | "manual" | "import"
  sourceId       String?   // Reference to campaign ID if from campaign

  // Multi-tenancy
  organizationId String
  createdById    String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User         @relation(fields: [createdById], references: [id])
  tasks          OutreachTask[]

  @@index([organizationId, status])
  @@index([organizationId, createdById])
}

// Outreach Tasks - Card deck for working through outreach actions
model OutreachTask {
  id             String    @id @default(uuid())

  // Who this task is for
  recipientId    String

  // Task details
  taskType       String    // GIFT | HANDWRITTEN_NOTE | VIDEO | EXPERIENCE | DIRECT_MAIL
  title          String
  description    String?   @db.Text

  // Context for the outreach (JSON: CRM data snapshot, talking points, manual notes)
  context        String?   @db.Text

  // Status tracking
  status         String    @default("PENDING") // PENDING | IN_PROGRESS | COMPLETED | SKIPPED
  priority       Int       @default(0) // Higher = more urgent

  // Optional campaign linkage
  campaignId     String?

  // Optional deck linkage
  deckId         String?

  // Result tracking - links to Send when completed
  sendId         String?   @unique
  completedAt    DateTime?
  completedById  String?
  skipReason     String?

  // Assignment
  assignedToId   String?

  // Scheduling
  dueDate        DateTime?

  // Ordering within the deck
  sortOrder      Int       @default(0)

  organizationId String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  recipient      Recipient    @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  campaign       Campaign?    @relation(fields: [campaignId], references: [id])
  deck           TaskDeck?    @relation(fields: [deckId], references: [id])
  send           Send?        @relation(fields: [sendId], references: [id])
  assignedTo     User?        @relation("AssignedTasks", fields: [assignedToId], references: [id])
  completedBy    User?        @relation("CompletedTasks", fields: [completedById], references: [id])

  @@index([organizationId, status])
  @@index([organizationId, assignedToId, status])
  @@index([recipientId])
  @@index([campaignId])
  @@index([deckId])
}

// Budget Management
model Budget {
  id             String   @id @default(uuid())
  name           String
  type           String   @default("MONTHLY") // MONTHLY | QUARTERLY | ANNUAL | CUSTOM
  amount         Float
  spent          Float    @default(0)
  currency       String   @default("USD")

  // Period
  startDate      DateTime
  endDate        DateTime

  // Alerts
  alertThreshold Float?   // Percentage (e.g., 80 = alert at 80% spent)
  alertSent      Boolean  @default(false)

  organizationId String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// CRM Synced Entities
// These models store data synced from external CRMs (HubSpot, Salesforce, Attio)

model Company {
  id             String   @id @default(uuid())
  name           String
  domain         String?
  industry       String?
  size           String?
  revenue        String?
  website        String?
  phone          String?
  address        String?
  city           String?
  state          String?
  country        String?
  description    String?  @db.Text
  organizationId String

  // External CRM sync tracking
  externalId     String?
  externalSource String?
  externalUrl    String?
  lastSyncedAt   DateTime?
  syncStatus     String?   @default("SYNCED")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts       Contact[]
  deals          Deal[]

  @@index([organizationId, externalId, externalSource])
  @@index([organizationId])
}

model Contact {
  id             String   @id @default(uuid())
  email          String
  firstName      String?
  lastName       String?
  phone          String?
  jobTitle       String?
  department     String?
  linkedinUrl    String?
  organizationId String
  companyId      String?

  // External CRM sync tracking
  externalId     String?
  externalSource String?
  externalUrl    String?
  lastSyncedAt   DateTime?
  syncStatus     String?   @default("SYNCED")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  company        Company?     @relation(fields: [companyId], references: [id])
  deals          Deal[]

  @@index([organizationId, externalId, externalSource])
  @@index([organizationId, email])
}

model Lead {
  id             String   @id @default(uuid())
  email          String
  firstName      String?
  lastName       String?
  phone          String?
  company        String?
  jobTitle       String?
  source         String   @default("OTHER")
  status         String   @default("NEW")
  organizationId String

  // External CRM sync tracking
  externalId     String?
  externalSource String?
  externalUrl    String?
  lastSyncedAt   DateTime?
  syncStatus     String?   @default("SYNCED")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, externalId, externalSource])
  @@index([organizationId, email])
}

model DealStage {
  id             String   @id @default(uuid())
  name           String
  order          Int
  probability    Float    @default(0)
  organizationId String

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deals          Deal[]

  @@index([organizationId, order])
}

model Deal {
  id             String    @id @default(uuid())
  name           String
  value          Float     @default(0)
  currency       String    @default("USD")
  status         String    @default("OPEN")
  probability    Float?
  expectedCloseDate DateTime?
  actualCloseDate   DateTime?
  notes          String?   @db.Text
  organizationId String
  stageId        String
  contactId      String?
  companyId      String?

  // External CRM sync tracking
  externalId     String?
  externalSource String?
  externalUrl    String?
  lastSyncedAt   DateTime?
  syncStatus     String?   @default("SYNCED")

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  stage          DealStage    @relation(fields: [stageId], references: [id])
  contact        Contact?     @relation(fields: [contactId], references: [id])
  company        Company?     @relation(fields: [companyId], references: [id])

  @@index([organizationId, externalId, externalSource])
  @@index([organizationId, status])
}

// Activity Tracking
model Activity {
  id             String    @id @default(uuid())
  type           String    // SEND_CREATED | SEND_SHIPPED | SEND_DELIVERED | RECIPIENT_ADDED | etc.
  subject        String?
  description    String?   @db.Text
  metadata       String?   @db.Text
  organizationId String
  userId         String
  recipientId    String?
  sendId         String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])
  recipient    Recipient?   @relation(fields: [recipientId], references: [id])
  send         Send?        @relation(fields: [sendId], references: [id])
}
